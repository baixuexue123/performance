#!/usr/bin/env python
# -*- coding: utf-8 -*-
from gevent.server import StreamServer
from gevent.pool import Pool


def hbt_handler(sock, addr):
    print('New connection from %s:%s' % addr)
    for l in sock.makefile('r', newline='\r\n'):
        if l.strip() == 'ping':
            sock.sendall(b'pong\r\n')
        else:
            print('ERROR: ', addr, 'Received: ', l)
    else:
        print('Connection(%s:%s) lost' % addr)


if __name__ == '__main__':
    pool = Pool(10000)  # do not accept more than 10000 connections
    server = StreamServer(('127.0.0.1', 8888), hbt_handler, spawn=pool)
    server.serve_forever()


# clients:  1000
# ================================ 9.706545114517212 ================================
# ************************ TOTAL ************************
# MAX: 9.499003410339355
# AVG: 9.25428615641594
# MIN: 9.02552604675293
#
# ************************ MAX ************************
# MAX: 0.05608963966369629
# AVG: 0.03300900411605835
# MIN: 0.0022406578063964844
#
# ************************ AVG ************************
# MAX: 0.02947258949279785
# AVG: 0.013019598793983463
# MIN: 0.0010308265686035157


# clients:  3000
# ================================ 10.871091604232788 ================================
# ************************ TOTAL ************************
# MAX: 9.477191925048828
# AVG: 9.23307802383105
# MIN: 9.021061658859253
#
# ************************ MAX ************************
# MAX: 0.2998349666595459
# AVG: 0.1757578759988149
# MIN: 0.0008027553558349609
#
# ************************ AVG ************************
# MAX: 0.04008963108062744
# AVG: 0.0205128795703252
# MIN: 0.0005551338195800781


# clients:  5000
# ================================ 12.591311693191528 ================================
# ************************ TOTAL ************************
# MAX: 9.700946569442749
# AVG: 9.283285055160523
# MIN: 9.015809774398804
#
# ************************ MAX ************************
# MAX: 0.5723006725311279
# AVG: 0.11952963824272156
# MIN: 0.0005257129669189453
#
# ************************ AVG ************************
# MAX: 0.0663184404373169
# AVG: 0.022580114803314236
# MIN: 0.0002629518508911133


# clients:  10000
# ================================ 17.48718500137329 ================================
# ************************ TOTAL ************************
# MAX: 10.936265230178833
# AVG: 10.19684678246975
# MIN: 9.408315420150757
#
# ************************ MAX ************************
# MAX: 0.8707871437072754
# AVG: 0.27052048354148867
# MIN: 0.09549403190612793
#
# ************************ AVG ************************
# MAX: 0.14577140808105468
# AVG: 0.08339982782125474
# MIN: 0.026600360870361328


# clients:  20000
# ================================ 53.70920419692993 ================================
# ************************ TOTAL ************************
# MAX: 16.559937238693237
# AVG: 10.789321912109852
# MIN: 9.042911529541016
#
# ************************ MAX ************************
# MAX: 5.702718734741211
# AVG: 0.3204992056846619
# MIN: 0.009103775024414062
#
# ************************ AVG ************************
# MAX: 0.6828679084777832
# AVG: 0.12176590752124826
# MIN: 0.0026116371154785156
