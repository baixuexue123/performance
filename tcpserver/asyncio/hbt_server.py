#!/usr/bin/env python
import asyncio
import uvloop


async def hbt_handler(reader, writer):
    addr = writer.get_extra_info('peername')
    print('New connection from %s:%s' % addr)
    while True:
        try:
            data = await reader.readuntil(b'\r\n')
        except asyncio.streams.IncompleteReadError:
            print('Connection(%s:%s) lost' % addr)
            break

        msg = data.decode()
        if msg == 'ping\r\n':
            writer.write(b'pong\r\n')
            await writer.drain()
        else:
            print('ERROR: ', addr, 'Received: ', msg)
            break

    writer.close()


loop = uvloop.new_event_loop()
# loop = asyncio.get_event_loop()
coro = asyncio.start_server(hbt_handler, '127.0.0.1', 8888, loop=loop)
server = loop.run_until_complete(coro)

print('Serving on {}'.format(server.sockets[0].getsockname()))
try:
    loop.run_forever()
except KeyboardInterrupt:
    pass

server.close()
loop.run_until_complete(server.wait_closed())
loop.close()


# clients:  1000
# ================================ 10.682135820388794 ================================
# ************************ TOTAL ************************
# MAX: 9.481036901473999
# AVG: 9.255617236614228
# MIN: 9.044308185577393
#
# ************************ MAX ************************
# MAX: 0.08515286445617676
# AVG: 0.044933780431747436
# MIN: 0.003943920135498047
#
# ************************ AVG ************************
# MAX: 0.020858001708984376
# AVG: 0.011837384605407713
# MIN: 0.0013568401336669922


# clients:  3000
# ================================ 10.424028158187866 ================================
# ************************ TOTAL ************************
# MAX: 9.193628072738647
# AVG: 9.095734486738841
# MIN: 9.02331829071045
#
# ************************ MAX ************************
# MAX: 0.06170153617858887
# AVG: 0.01563646705945333
# MIN: 0.0002963542938232422
#
# ************************ AVG ************************
# MAX: 0.009710192680358887
# AVG: 0.002567050139109287
# MIN: 0.0001302003860473633


# clients:  5000
# ================================ 12.28918743133545 ================================
# ************************ TOTAL ************************
# MAX: 9.322821140289307
# AVG: 9.156280084657668
# MIN: 9.024837732315063
#
# ************************ MAX ************************
# MAX: 0.13486576080322266
# AVG: 0.04568728346824646
# MIN: 0.0008747577667236328
#
# ************************ AVG ************************
# MAX: 0.01943373680114746
# AVG: 0.00697346964359283
# MIN: 0.00028090476989746095


# clients:  10000
# ================================ 16.272114753723145 ================================
# ************************ TOTAL ************************
# MAX: 10.444553136825562
# AVG: 9.989925665807723
# MIN: 9.413467168807983
#
# ************************ MAX ************************
# MAX: 0.2790858745574951
# AVG: 0.18256281957626344
# MIN: 0.03520321846008301
#
# ************************ AVG ************************
# MAX: 0.09476261138916016
# AVG: 0.05980733212470997
# MIN: 0.01286156177520752


# clients:  20000
# ================================ 54.938419818878174 ================================
# ************************ TOTAL ************************
# MAX: 12.31398630142212
# AVG: 10.696445007133484
# MIN: 9.07133960723877
#
# ************************ MAX ************************
# MAX: 0.694246768951416
# AVG: 0.3091770362854004
# MIN: 0.008054256439208984
#
# ************************ AVG ************************
# MAX: 0.2347569227218628
# AVG: 0.10769932139396704
# MIN: 0.0014625072479248046
